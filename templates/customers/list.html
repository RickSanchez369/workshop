{% extends "base.html" %}
{% load static %}
{% load humanize dict_filters %}
{% load jalali_filters %}

{% block title %}Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§{% endblock %}

{% block content %}
<div class="container">
    <h4 class="mb-4">ğŸ‘¤ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§</h4>

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <!-- Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† -->
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
            â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø´ØªØ±ÛŒ
        </button>

        <!-- ÙØ±Ù… Ø¬Ø³ØªØ¬Ùˆ -->
        <form method="get" class="d-flex" role="search">
            <input type="text" name="q" class="form-control me-2" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§Ø³Ø§Ø³ Ù†Ø§Ù…"
                   value="{{ request.GET.q }}">
            <button class="btn btn-outline-secondary" type="submit">Ø¬Ø³ØªØ¬Ùˆ</button>
        </form>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-info">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Ù†Ø§Ù…</th>
                    <th>Ø´Ù…Ø§Ø±Ù‡</th>
                    <th>Ù…Ø¬Ù…ÙˆØ¹</th>
                    <th>Ù¾Ø±Ø¯Ø§Ø®Øª</th>
                    <th>Ø¨Ø¯Ù‡ÛŒ</th>
                    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                </tr>
            </thead>
            <tbody>
                {% for item in customer_data %}
                    <tr>
                        <td>
                            {{ item.customer.name }}
                            <button class="btn btn-sm btn-link" data-bs-toggle="collapse" data-bs-target="#details{{ item.customer.id }}">
                                ğŸ“‹
                            </button>
                        </td>
                        <td>{{ item.customer.phone }}</td>
                        <td>{{ item.total_invoice|comma }}</td>
                        <td>{{ item.total_paid|comma }}</td>
                        <td>{{ item.total_debt|comma }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editCustomerModal{{ item.customer.id }}">âœï¸</button>
                            <button class="btn btn-sm btn-outline-success"
                                    data-bs-toggle="modal"
                                    data-bs-target="#paymentCustomerModal{{ item.customer.id }}">ğŸ’µ</button>
                        </td>
                    </tr>
            
                    <!-- Ø¬Ø²Ø¦ÛŒØ§Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ -->
                    <tr class="collapse bg-light" id="details{{ item.customer.id }}">
                        <td colspan="6">
                            {% with invoices=invoices_by_customer|dict_get:item.customer.id %}
                                {% if invoices %}
                                    <div style="max-height: 250px; overflow-y: auto;">
                                        <table class="table table-sm table-bordered mb-0">
                                            <thead class="table-light">
                                                <tr class="small text-center">
                                                    <th>ØªØ§Ø±ÛŒØ®</th>
                                                    <th>Ø´Ù…Ø§Ø±Ù‡</th>
                                                    <th>Ø·Ø±Ø­</th>
                                                    <th>ØªØ¹Ø¯Ø§Ø¯</th>
                                                    <th>Ù…Ø¨Ù„Øº</th>
                                                    <th>Ø¨Ø¯Ù‡ÛŒ</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for invoice in invoices %}
                                                    <tr class="small text-center">
                                                        <td>{{ invoice.date }}</td>
                                                        <td>{{ invoice.invoice_number }}</td>
                                                        <td>{{ invoice.design.title }}</td>
                                                        <td>{{ invoice.quantity }}</td>
                                                        <td>{{ invoice.total_price|comma }}</td>
                                                        <td>{{ invoice.remaining_debt|comma }}</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-muted small">ÙØ§Ú©ØªÙˆØ±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
                                {% endif %}
                            {% endwith %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">Ù‡ÛŒÚ† Ù…Ø´ØªØ±ÛŒâ€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td>
                    </tr>
                {% endfor %}
            </tbody>    
        </table>
    </div>
    
    <!-- Modal Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø´ØªØ±ÛŒ -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form method="POST" class="modal-content">
                {% csrf_token %}
                <input type="hidden" name="add_customer" value="1">
                <div class="modal-header">
                    <h5 class="modal-title">â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ù†Ø§Ù…</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</label>
                        <input type="text" name="phone" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø¢Ø¯Ø±Ø³</label>
                        <textarea name="address" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø´ØªØ±ÛŒ -->
    {% for customer in customers %}
    <div class="modal fade" id="editCustomerModal{{ customer.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form method="POST" class="modal-content">
                {% csrf_token %}
                <input type="hidden" name="edit_customer" value="1">
                <input type="hidden" name="customer_id" value="{{ customer.id }}">
                <div class="modal-header">
                    <h5 class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ {{ customer.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ù†Ø§Ù…</label>
                        <input type="text" name="name" value="{{ customer.name }}" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</label>
                        <input type="text" name="phone" value="{{ customer.phone }}" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø¢Ø¯Ø±Ø³</label>
                        <textarea name="address" class="form-control" rows="2">{{ customer.address }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>
    {% endfor %}

    <!-- Modal Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø¯Ù‡ÛŒ -->
    {% for item in customer_data %}
    {% with customer=item.customer debt=item.total_debt %}
    <div class="modal fade" id="paymentCustomerModal{{ customer.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form method="POST" class="modal-content">
                {% csrf_token %}
                <input type="hidden" name="add_payment" value="1">
                <input type="hidden" name="customer_id" value="{{ customer.id }}">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">ğŸ’µ Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª - {{ customer.name }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label">Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ (ØªÙˆÙ…Ø§Ù†)</label>
                        <button type="button" class="btn btn-sm btn-outline-primary"
                                onclick="settleCustomer({{ debt }}, this)">
                            ğŸ” ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ù…Ù„
                        </button>
                        <input type="text" class="form-control formatted-amount" placeholder="Ù…Ø«Ù„Ø§Ù‹ 1,200,000" required>
                        <input type="hidden" name="payment_amount" class="raw-amount" data-max="{{ debt }}">
                    </div> 
    
                    <div id="overpayWarning{{ customer.id }}" class="alert alert-warning mt-2 d-none">
                        âš ï¸ Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø¨Ø¯Ù‡ÛŒ Ù…Ø´ØªØ±ÛŒ Ø§Ø³Øª!
                    </div>
                    
                    <!-- ğŸ”» ÙÛŒÙ„Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ ÙˆØ¬Ù‡ -->
                    <div class="mb-3">
                        <label class="form-label">Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</label>
                        <select class="form-select" name="received_by" required>
                        {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }}</option>
                        {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="date" class="form-label">ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª</label>
                        <input type="text" name="date" class="form-control jalali-datepicker" required>
                    </div>
                    
                    <p class="text-muted">Ø¨Ø¯Ù‡ÛŒ ÙØ¹Ù„ÛŒ: {{ debt|comma }} ØªÙˆÙ…Ø§Ù†</p>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </form>
        </div>
    </div>
    {% endwith %}
    {% endfor %}
    
</div> <!-- Ù¾Ø§ÛŒØ§Ù† container -->
{% endblock %}

{% block extra_js %}
<script>
    function settleCustomer(debt, button) {
        const modal = button.closest('.modal');
        const inputFormatted = modal.querySelector('.formatted-amount');
        const inputRaw = modal.querySelector('.raw-amount');
        const warning = modal.querySelector('[id^=overpayWarning]');
    
        inputFormatted.value = debt.toLocaleString();
        inputRaw.value = debt;
        warning.classList.add("d-none");
    }
    
    document.querySelectorAll('.formatted-amount').forEach(el => {
        el.addEventListener('input', function () {
            const rawInput = el.value.replace(/,/g, '').replace(/[^\d]/g, '');
            const modal = el.closest('.modal');
            const inputHidden = modal.querySelector('.raw-amount');
            const warning = modal.querySelector('[id^=overpayWarning]');
            const max = parseInt(inputHidden.dataset.max || "0");
    
            el.value = rawInput.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            inputHidden.value = rawInput;
    
            if (parseInt(rawInput) > max) {
                warning.classList.remove("d-none");
            } else {
                warning.classList.add("d-none");
            }
        });
    });
</script>
    
{% endblock extra_js %}

