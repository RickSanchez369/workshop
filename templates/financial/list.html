{% extends "base.html" %}
{% load humanize dict_filters %}  <!-- Ø¨Ø±Ø§ÛŒ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø²Ø§Ø±Ú¯Ø§Ù† -->


{% block title %}ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù„ÛŒ{% endblock %}

{% block content %}
<div class="container">
    <h4 class="mb-4">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù„ÛŒ</h4>

    <!-- âœ… Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯) -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- âœ… ÙØ±Ù… Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ® Ùˆ Ù†Ø±Ø® Ø¯Ù„Ø§Ø± -->
    <div class="card shadow-sm rounded-4 mb-4">
        <div class="card-body">
            <form method="POST" class="row g-3 align-items-end">
                {% csrf_token %}

                <!-- Ø¨Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ® -->
                <div class="col-md-4">
                    <label class="form-label">Ø§Ø² ØªØ§Ø±ÛŒØ®</label>
                    <input type="text" name="start_date" class="form-control jalali-datepicker" required
                            value="{{ request.POST.start_date }}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">ØªØ§ ØªØ§Ø±ÛŒØ®</label>
                    <input type="text" name="end_date" class="form-control jalali-datepicker" required
                            value="{{ request.POST.end_date }}">
                </div>

                <!-- Ù†Ø±Ø® Ø¯Ù„Ø§Ø± -->
                <div class="col-md-3">
                    <label class="form-label">Ù†Ø±Ø® Ø¯Ù„Ø§Ø± (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="text" id="usd_rate_display" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹ 52,300" required>
                    <input type="hidden" name="usd_rate" id="usd_rate_real">

                </div>

                <div class="col-md-1 d-grid">
                    <button type="submit" class="btn btn-primary">ğŸ“Š Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- âœ… Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡ Ú¯Ø²Ø§Ø±Ø´ ÙÙ‚Ø· Ø§Ú¯Ø± report ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ -->
    {% if report %}
        <!-- ğŸ“ˆ Ø®Ù„Ø§ØµÙ‡ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù„ÛŒ Ø¨Ø§ Ø§Ø³ØªØ§ÛŒÙ„ ØªØ±Ú©ÛŒØ¨ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ -->
        <div class="bg-white rounded-3 shadow p-4 mb-5">
            <h4 class="text-center fw-bold mb-4">ğŸ“ˆ Ø®Ù„Ø§ØµÙ‡ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù„ÛŒ</h4>

            <div class="row text-center fs-5">
                <!-- Ù‚ÙˆØ§Ø±Ù‡ -->
                <div class="col-md-3 mb-3">
                    <div class="py-3 rounded-3 border btn-outline-secondary shadow-sm">
                        Ù…Ø¬Ù…ÙˆØ¹ Ù‚ÙˆØ§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±ÙˆØ®ØªÙ‡â€ŒØ´Ø¯Ù‡<br>
                        <strong class="text-dark">{{ report.total_pieces_sold|comma }}</strong>
                    </div>
                </div>
                <!-- ÙØ±ÙˆØ´ -->
                <div class="col-md-3 mb-3">
                    <div class="py-3 rounded-3 border btn-outline-success shadow-sm">
                        Ø¬Ù…Ø¹ Ú©Ù„ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ ÙØ±ÙˆØ´<br>
                        <strong class="text-success">{{ report.total_sales_amount|comma }} ØªÙˆÙ…Ø§Ù†</strong>
                    </div>
                </div>
                <!-- Ù‡Ø²ÛŒÙ†Ù‡ Ø³Ù†Ú¯ -->
                <div class="col-md-3 mb-3">
                    <div class="py-3 rounded-3 border btn-outline-warning shadow-sm">
                        Ø¬Ù…Ø¹ Ù‡Ø²ÛŒÙ†Ù‡ Ø³Ù†Ú¯<br>
                        <strong class="text-warning">{{ report.total_stone_cost|comma }} ØªÙˆÙ…Ø§Ù†</strong>
                    </div>
                </div>
                <!-- Ø³Ø§ÛŒØ± Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ -->
                <div class="col-md-3 mb-3">
                    <div class="py-3 rounded-3 border btn-outline-danger shadow-sm">
                        Ø¬Ù…Ø¹ Ø³Ø§ÛŒØ± Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§<br>
                        <strong class="text-danger">{{ report.total_expenses|comma }} ØªÙˆÙ…Ø§Ù†</strong>
                    </div>
                </div>
            </div>

            <!-- Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ -->
            <div class="text-center mt-4 fs-4">
                <span class="text-success fw-bold">ğŸ’° Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ:</span>
                <strong class="text-success">{{ report.net_profit|comma }} ØªÙˆÙ…Ø§Ù†</strong>
            </div>
            <!-- Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±ÛŒØ§ÙØªÛŒ Ùˆ Ø¨Ø¯Ù‡ÛŒ -->
            <div class="row text-center fs-5 mt-4">
                <div class="col-md-6">
                    <div class="py-3 rounded-3 border btn-outline-primary shadow-sm">
                        ğŸ’µ Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØªÛŒâ€ŒÙ‡Ø§ (ÙØ§Ú©ØªÙˆØ± + Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø³ØªÛŒ)<br>
                        <strong class="text-primary">{{ total_received|comma }} ØªÙˆÙ…Ø§Ù†</strong>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="py-3 rounded-3 border btn-outline-danger shadow-sm">
                        ğŸ’¸ Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡<br>
                        <strong class="text-danger">{{ total_unpaid|comma }} ØªÙˆÙ…Ø§Ù†</strong>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% if report %}
    <!-- ğŸ§¾ Ù„ÛŒØ³Øª Ù…Ø´ØªØ±ÛŒâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¯Ø± Ø¨Ø§Ø²Ù‡ ÙØ§Ú©ØªÙˆØ± Ø¯Ø§Ø±Ù†Ø¯ -->
    <h5 class="mb-3">ğŸ§¾ Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¯Ø§Ø±Ø§ÛŒ ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ</h5>
    <div style="max-height: 400px; overflow-y: auto;" class="border rounded-3 table-responsive shadow-sm mb-4">
        <table class="table table-bordered align-middle text-center mb-0">
            <thead class="table-light">
                <tr>
                    <th>Ù…Ø´ØªØ±ÛŒ</th>
                    <th>Ù…Ø¬Ù…ÙˆØ¹ Ù‚ÙˆØ§Ø±Ù‡â€ŒÙ‡Ø§</th>
                    <th>Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</th>
                    <th>Ø¨Ø¯Ù‡ÛŒ</th>
                    <th>Ø¬Ø²Ø¦ÛŒØ§Øª</th>
                </tr>
            </thead>
            <tbody>
                {% for cid, data in customers_data.items %}
                <tr>
                    <td>{{ data.name }}</td>
                    <td>{{ data.total_quantity|comma }}</td>
                    <td>{{ data.total_paid|comma }}</td>
                    <td>{{ data.total_debt|comma }}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#inv{{ cid }}">
                            ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡
                        </button>
                    </td>
                </tr>
                <tr class="collapse bg-light" id="inv{{ cid }}">
                    <td colspan="5">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0">
                                <thead>
                                    <tr>
                                        <th>ØªØ§Ø±ÛŒØ®</th>
                                        <th>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±</th>
                                        <th>ØªØ¹Ø¯Ø§Ø¯</th>
                                        <th>Ù…Ø¨Ù„Øº</th>
                                        <th>Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</th>
                                        <th>Ø¨Ø¯Ù‡ÛŒ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for inv in data.invoices %}
                                    <tr>
                                        <td>{{ inv.date }}</td>
                                        <td>{{ inv.invoice_number }}</td>
                                        <td>{{ inv.quantity }}</td>
                                        <td>{{ inv.total_price|comma }}</td>
                                        <td>{{ inv.amount_paid|comma }}</td>
                                        <td>{{ inv.remaining_debt|comma }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>    

    <!-- âœ… Ø¬Ø¯ÙˆÙ„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡ Ø¯Ø± Ø¨Ø§Ø²Ù‡ -->
    <div class="card shadow-sm rounded-4 mb-4">
        <div class="card-header">
            <strong>ğŸ’° Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</strong>
        </div>
        <div class="card-body table-responsive">
            <table class="table table-bordered table-hover text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ØªØ§Ø±ÛŒØ®</th>
                        <th>Ú©Ø§Ø±Ø¨Ø±</th>
                        <th>Ù…Ø¨Ù„Øº</th>
                        <th>Ø¨Ø§Ø¨Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                        <tr>
                            <td>{{ expense.date }}</td>
                            <td>{{ expense.user.username }}</td>
                            <td>{{ expense.amount|comma }}</td>
                            <td>{{ expense.note }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="text-muted">Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- âœ… Ø¬Ø¯ÙˆÙ„ Ø³Ù†Ú¯ Ù‡Ø§ÛŒ Ù…ØµØ±Ù Ø´Ø¯Ù‡ Ø¯Ø± Ø¨Ø§Ø²Ù‡ -->
    <h5 class="mt-5 mb-3">ğŸ’ Ø³Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…ØµØ±Ùâ€ŒØ´Ø¯Ù‡ Ø¯Ø± Ø¨Ø§Ø²Ù‡</h5>
    <div class="table-responsive mb-4">
        <table class="table table-bordered text-center align-middle shadow-sm">
            <thead class="table-light">
                <tr>
                    <th>ØªØ§Ø±ÛŒØ®</th>
                    <th>Ù†ÙˆØ¹ Ø³Ù†Ú¯</th>
                    <th>Ù…Ù‚Ø¯Ø§Ø± (Ú©Ø§Ø±ØªÙ†)</th>
                    <th>Ù‚ÛŒÙ…Øª Ù‡Ø± Ú©Ø§Ø±ØªÙ† (Ø¯Ù„Ø§Ø±)</th>
                    <th>Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù„ (ØªÙˆÙ…Ø§Ù†)</th>
                </tr>
            </thead>
            <tbody>
                {% for s in stone_consumptions %}
                <tr>
                    <td>{{ s.date }}</td>
                    <td>{{ s.stone }}</td>
                    <td>{{ s.quantity }}</td>
                    <td>{{ s.price_usd }}</td>
                    <td>{{ s.cost_toman|comma }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-muted">Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ Ù‡ÛŒÚ† Ù…ØµØ±ÙÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ğŸ‘¥ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù„ÛŒ -->
    <h5 class="mt-5 mb-3">ğŸ‘¥ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h5>
    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle shadow-sm">
            <thead class="table-light">
                <tr>
                    <th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±</th>
                    <th>ğŸ’° Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØªÛŒ</th>
                    <th>ğŸ’¸ Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¯Ù‡ÛŒ</th>
                    <th>ğŸ“„ ØªØ¹Ø¯Ø§Ø¯ Ú†Ú©</th>
                    <th>ğŸ“‹ Ø¬Ø²ÛŒÛŒØ§Øª Ú†Ú©â€ŒÙ‡Ø§</th>
                </tr>
            </thead>
            <tbody>
                {% for uid, user in users_data.items %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td class="text-success fw-bold">{{ user.net_received|comma }} ØªÙˆÙ…Ø§Ù†</td>
                    <td class="text-danger">{{ user.total_debt|comma }} ØªÙˆÙ…Ø§Ù†</td>
                    <td>{{ user.check_count }}</td>
                    <td>
                        {% if user.check_count > 0 %}
                        <button class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#userChecks{{ uid }}">
                            ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡
                        </button>
                        {% else %}
                        <span class="text-muted">â€”</span>
                        {% endif %}
                    </td>
                </tr>

                {% if user.check_count > 0 %}
                <tr class="collapse bg-light" id="userChecks{{ uid }}">
                    <td colspan="5">
                        <ul class="list-group text-start">
                            {% for check in user.checks %}
                            <li class="list-group-item">
                                ğŸ“… <strong>ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯:</strong> {{ check.date }}<br>
                                ğŸ“ <strong>ØªÙˆØ¶ÛŒØ­:</strong> {{ check.note }}
                            </li>
                            {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- âœ… Ø¯Ú©Ù…Ù‡ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾ ØµÙØ­Ù‡ -->
    <div class="text-center mt-4">
        <a href="{% url 'financial_export' %}" class="btn btn-primary btn-lg">
            ğŸ“„ Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´ Word
        </a>
    </div>    
{% endif %}

</div> <!-- Ù¾Ø§ÛŒØ§Ù† container -->
{% endblock %}


{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const display = document.getElementById('usd_rate_display');
        const real = document.getElementById('usd_rate_real');
    
        function syncUsdRate() {
            const raw = display.value.replace(/,/g, '');
            if (!isNaN(raw) && raw !== '') {
                display.value = Number(raw).toLocaleString('en-US');
                real.value = raw;
            } else {
                real.value = '';
            }
        }
    
        // ğŸ“Œ Ø§Ø¬Ø±Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ ØµÙØ­Ù‡ (Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶)
        syncUsdRate();
    
        // ğŸ“Œ Ø§Ø¬Ø±Ø§ Ø¯Ø± Ø²Ù…Ø§Ù† ØªØ§ÛŒÙ¾
        display.addEventListener('input', syncUsdRate);
    });
</script>    
{% endblock %}

