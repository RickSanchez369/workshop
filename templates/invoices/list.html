{% extends "base.html" %}
{% load humanize dict_filters %}

{% block title %}ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ ÙØ±ÙˆØ´{% endblock %}

{% block content %}
<div class="container">
    <h4 class="mb-4">ğŸ§¾ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ ÙØ±ÙˆØ´</h4>

    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
        <!-- Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† ÙØ§Ú©ØªÙˆØ± -->
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInvoiceModal">
            â• ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯
        </button>

        <!-- ÙØ±Ù… Ø¬Ø³ØªØ¬Ùˆ -->
        <form method="get" class="d-flex" role="search">
            <input type="text" name="q" class="form-control me-2" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´ØªØ±ÛŒ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±"
                   value="{{ request.GET.q }}">
            <button class="btn btn-outline-secondary" type="submit">Ø¬Ø³ØªØ¬Ùˆ</button>
        </form>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle text-center">
            <thead class="table-light">
                <tr>
                    <th>ØªØ§Ø±ÛŒØ®</th>
                    <th>Ø´Ù…Ø§Ø±Ù‡</th>
                    <th>Ù…Ø´ØªØ±ÛŒ</th>
                    <th>Ø·Ø±Ø­</th>
                    <th>Ø³Ù†Ú¯</th>
                    <th>ØªØ¹Ø¯Ø§Ø¯</th>
                    <th>Ù‚ÛŒÙ…Øª Ø·Ø±Ø­</th>  <!-- Ø³ØªÙˆÙ† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ -->
                    <th>Ù‚ÛŒÙ…Øª Ú©Ù„</th>
                    <th>Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</th>
                    <th>Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</th>
                    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                </tr>
            </thead>
            <tbody>
                {% for invoice in invoices %}
                    <tr>
                        <td>{{ invoice.date }}</td>
                        <td>{{ invoice.invoice_number }}</td>
                        <td>{{ invoice.customer.name }}</td>
                        <td>{{ invoice.design.title }}</td>
                        <td>{{ invoice.stone.name }}</td>
                        <td>{{ invoice.quantity }}</td>
                        <td>{{ invoice.design_price_per_piece|comma }}</td>
                        <td>{{ invoice.total_price|comma }}</td>
                        <td>{{ invoice.amount_paid|comma }}</td>
                        <td>{{ invoice.remaining_debt|comma }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal"
                                    data-bs-target="#editInvoiceModal{{ invoice.id }}">
                                âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´
                            </button>
                        </td>                        
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="9" class="text-muted text-center">ÙØ§Ú©ØªÙˆØ±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <!-- ğŸ“„ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ -->
        <nav aria-label="page navigation" class="mt-3">
            <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">Ù‚Ø¨Ù„ÛŒ</a>
                </li>
            {% endif %}
        
            {% for num in page_obj.paginator.page_range %}
                <li class="page-item {% if num == page_obj.number %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a>
                </li>
            {% endfor %}
        
            {% if page_obj.has_next %}
                <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">Ø¨Ø¹Ø¯ÛŒ</a>
                </li>
            {% endif %}
            </ul>
        </nav>
    </div>
</div> <!-- Ù¾Ø§ÛŒØ§Ù† container -->

<!-- Modal Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯ -->
<div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form method="POST" class="modal-content">
            {% csrf_token %}
            <input type="hidden" name="add_invoice" value="1">

            <div class="modal-header">
                <h5 class="modal-title">â• Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´ Ø¬Ø¯ÛŒØ¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
            </div>

            <div class="modal-body row g-3">

                <!-- ØªØ§Ø±ÛŒØ® ÙØ§Ú©ØªÙˆØ± -->
                <div class="col-md-6">
                    <label class="form-label">ØªØ§Ø±ÛŒØ® ÙØ§Ú©ØªÙˆØ±</label>
                    <input type="text" name="date" class="form-control jalali-datepicker" required>
                </div>

                <!-- ØµØ§Ø¯Ø±Ú©Ù†Ù†Ø¯Ù‡ -->
                <div class="col-md-6">
                    <label class="form-label">ØµØ§Ø¯Ø±Ú©Ù†Ù†Ø¯Ù‡</label>
                    <select name="issuer" class="form-select" required>
                        <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± --</option>
                        {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Ù…Ø´ØªØ±ÛŒ -->
                <div class="col-md-6">
                    <label class="form-label">Ù…Ø´ØªØ±ÛŒ</label>
                    <!-- ğŸ”¹ Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯ -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Ù…Ø´ØªØ±ÛŒ</label>
                            <button type="button" class="btn btn-sm btn-outline-success"
                                    data-bs-toggle="collapse" data-bs-target="#newCustomerForm">
                                â• Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯
                            </button>
                    </div>
                    <select id="customerSelect" name="customer" class="form-select" style="width: 100%;">
                        <option value="">Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´ØªØ±ÛŒ...</option>
                    </select>
                    <!-- ğŸ”¹ ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯ -->
                    <div class="collapse mb-3" id="newCustomerForm">
                        <div class="card card-body bg-light border">
                            <h6 class="mb-3">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯</h6>

                            <div class="mb-2">
                                <input type="text" name="new_customer_name" class="form-control" placeholder="Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ">
                            </div>
                            <div class="mb-2">
                                <input type="text" name="new_customer_phone" class="form-control" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³">
                            </div>
                            <div class="mb-2">
                                <input type="text" name="new_customer_address" class="form-control" placeholder="Ø¢Ø¯Ø±Ø³">
                            </div>

                            <div class="form-text text-muted">Ù¾Ø³ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡ØŒ Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù„ÛŒØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
                        </div>
                    </div>
                </div>

                <!-- Ø·Ø±Ø­ -->
                <div class="col-md-6">
                    <label class="form-label">Ø·Ø±Ø­</label>
                    <select name="design" class="form-select" required>
                        <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ø­ --</option>
                        {% for d in designs %}
                            <option value="{{ d.id }}">{{ d.title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Ø³Ù†Ú¯ -->
                <div class="col-md-6">
                    <label class="form-label">Ù†ÙˆØ¹ Ø³Ù†Ú¯</label>
                    <select name="stone" class="form-select" required>
                        <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ù†Ú¯ --</option>
                        {% for s in stones %}
                            <option value="{{ s.id }}">{{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Ù‚ÛŒÙ…Øª Ù‚ÙˆØ§Ø±Ù‡ -->
                <div class="col-md-6">
                    <label class="form-label">Ù‚ÛŒÙ…Øª Ù‡Ø± Ù‚ÙˆØ§Ø±Ù‡ (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="text" name="design_price_per_piece" class="form-control" min="0" required oninput="formatInputNumber(this)">
                </div>

                <!-- ØªØ¹Ø¯Ø§Ø¯ -->
                <div class="col-md-4">
                    <label class="form-label">ØªØ¹Ø¯Ø§Ø¯ Ù‚ÙˆØ§Ø±Ù‡</label>
                    <input type="number" name="quantity" class="form-control" min="1" required>

                    <!-- âœ… Ù†Ù…Ø§ÛŒØ´ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¬Ù…Ø¹ Ú©Ù„ Ù‚Ø¨Ù„ Ø§Ø² ØªØ®ÙÛŒÙ -->
                    <div class="form-text text-end mt-1 mb-3">
                        <strong>Ø¬Ù…Ø¹ Ú©Ù„ (Ø¨Ø¯ÙˆÙ† ØªØ®ÙÛŒÙ):</strong>
                        <span id="calculatedTotal" class="text-primary fw-bold">Û°</span> ØªÙˆÙ…Ø§Ù†
                    </div>
                </div>

                <!-- ØªØ®ÙÛŒÙ -->
                <div class="col-md-4">
                    <label class="form-label">ØªØ®ÙÛŒÙ (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="text" name="discount" class="form-control" min="0" value="0" oninput="formatInputNumber(this)" onfocus="clearIfZero(this)">
                </div>

                <!-- Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ -->
                <div class="col-md-4">
                    <label class="form-label">Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡ (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="text" name="amount_paid" class="form-control" min="0" value="0" required oninput="formatInputNumber(this)" onfocus="clearIfZero(this)">
                </div>

                <!-- Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª -->
                <div class="col-md-6">
                    <label class="form-label">Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª</label>
                    <select name="payment_type" class="form-select" required>
                        <option value="cash">Ù†Ù‚Ø¯ÛŒ</option>
                        <option value="check">Ú†Ú©</option>
                    </select>
                </div>

                <!-- âœ… Ù†Ù…Ø§ÛŒØ´ ÙÙ‚Ø· Ù‡Ù†Ú¯Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨ "Ú†Ú©" -->
                <div id="checkFields" class="d-none">
                    <div class="mb-2">
                        <label class="form-label">ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ Ú†Ú©</label>
                        <input type="text" name="check_due_date" class="form-control jalali-datepicker">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">ØªÙˆØ¶ÛŒØ­ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                        <textarea name="note" rows="2" class="form-control"></textarea>
                    </div>
                </div>


            </div>

            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ±</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
            </div>
        </form>
    </div>
</div>

{% for invoice in invoices %}
<div class="modal fade" id="editInvoiceModal{{ invoice.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="edit_invoice" value="1">
      <input type="hidden" name="invoice_id" value="{{ invoice.id }}">

      <div class="modal-header">
        <h5 class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ± {{ invoice.invoice_number }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>
      </div>

      <div class="modal-body row g-3">

        <!-- ØªØ§Ø±ÛŒØ® -->
        <div class="col-md-6">
          <label class="form-label">ØªØ§Ø±ÛŒØ®</label>
          <input type="text" name="date" class="form-control jalali-datepicker" value="{{ invoice.date|date:'Y/m/d' }}">
        </div>

        <!-- ØµØ§Ø¯Ø±Ú©Ù†Ù†Ø¯Ù‡ -->
        <div class="col-md-6">
          <label class="form-label">ØµØ§Ø¯Ø±Ú©Ù†Ù†Ø¯Ù‡</label>
          <select name="issuer" class="form-select">
            {% for user in users %}
              <option value="{{ user.id }}" {% if invoice.issuer.id == user.id %}selected{% endif %}>{{ user.username }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Ù…Ø´ØªØ±ÛŒ -->
        <div class="col-md-6">
          <label class="form-label">Ù…Ø´ØªØ±ÛŒ</label>
          <select name="customer" class="form-select">
            {% for c in customers %}
              <option value="{{ c.id }}" {% if invoice.customer.id == c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Ø·Ø±Ø­ -->
        <div class="col-md-6">
          <label class="form-label">Ø·Ø±Ø­</label>
          <select name="design" class="form-select">
            {% for d in designs %}
              <option value="{{ d.id }}" {% if invoice.design.id == d.id %}selected{% endif %}>{{ d.title }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Ø³Ù†Ú¯ -->
        <div class="col-md-6">
          <label class="form-label">Ø³Ù†Ú¯</label>
          <select name="stone" class="form-select">
            {% for s in stones %}
              <option value="{{ s.id }}" {% if invoice.stone.id == s.id %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Ù‚ÛŒÙ…Øª Ù‚ÙˆØ§Ø±Ù‡ -->
        <div class="col-md-6">
          <label class="form-label">Ù‚ÛŒÙ…Øª Ù‡Ø± Ù‚ÙˆØ§Ø±Ù‡</label>
          <input type="text" name="design_price_per_piece" class="form-control"
                 value="{{ invoice.design_price_per_piece|comma }}">
        </div>

        <!-- ØªØ¹Ø¯Ø§Ø¯ -->
        <div class="col-md-4">
          <label class="form-label">ØªØ¹Ø¯Ø§Ø¯</label>
          <input type="number" name="quantity" class="form-control" value="{{ invoice.quantity }}">
        </div>

        <!-- ØªØ®ÙÛŒÙ -->
        <div class="col-md-4">
          <label class="form-label">ØªØ®ÙÛŒÙ</label>
          <input type="text" name="discount" class="form-control" value="{{ invoice.discount|comma }}">
        </div>

        <!-- Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ -->
        <div class="col-md-4">
          <label class="form-label">Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡</label>
          <input type="text" name="amount_paid" class="form-control" value="{{ invoice.amount_paid|comma }}">
        </div>

        <!-- Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª -->
        <div class="col-md-6">
          <label class="form-label">Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª</label>
          <select name="payment_type" class="form-select">
            <option value="cash" {% if invoice.payment_type == 'cash' %}selected{% endif %}>Ù†Ù‚Ø¯ÛŒ</option>
            <option value="check" {% if invoice.payment_type == 'check' %}selected{% endif %}>Ú†Ú©</option>
          </select>
        </div>

        <!-- ØªØ§Ø±ÛŒØ® Ú†Ú© Ùˆ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª -->
        <div class="col-md-6">
          <label class="form-label">ØªØ§Ø±ÛŒØ® Ú†Ú©</label>
          <input type="text" name="check_due_date" class="form-control jalali-datepicker"
                 value="{{ invoice.check_due_date|default:'' }}">
        </div>

        <div class="col-12">
          <label class="form-label">ØªÙˆØ¶ÛŒØ­</label>
          <textarea name="note" class="form-control">{{ invoice.note }}</textarea>
        </div>

      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Ø°Ø®ÛŒØ±Ù‡</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
      </div>
    </form>
  </div>
</div>
{% endfor %}



{% endblock content %}

{% block extra_js %}
<script>
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    
    function updateTotal() {
        const priceInput = document.querySelector('[name="design_price_per_piece"]');
        const qtyInput = document.querySelector('[name="quantity"]');
        const totalDisplay = document.getElementById("calculatedTotal");
    
        // Ø­Ø°Ù ÙˆÛŒØ±Ú¯ÙˆÙ„â€ŒÙ‡Ø§ Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒ Ù‚ÛŒÙ…Øª
        const rawPrice = priceInput.value.replace(/,/g, '');
        const price = parseInt(rawPrice) || 0;
    
        const quantity = parseInt(qtyInput.value) || 0;
    
        const total = price * quantity;
        totalDisplay.innerText = formatNumber(total);
    }
    
    
    // Ø§Ø¬Ø±Ø§ÛŒ Ø²Ù†Ø¯Ù‡ Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§
    document.addEventListener("DOMContentLoaded", function() {
        const priceInput = document.querySelector('[name="design_price_per_piece"]');
        const qtyInput = document.querySelector('[name="quantity"]');
    
        priceInput.addEventListener("input", updateTotal);
        qtyInput.addEventListener("input", updateTotal);
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const paymentSelect = document.querySelector('[name="payment_type"]');
        const checkFields = document.getElementById("checkFields");
    
        function toggleCheckFields() {
            if (paymentSelect.value === "check") {
                checkFields.classList.remove("d-none");
            } else {
                checkFields.classList.add("d-none");
            }
        }
    
        paymentSelect.addEventListener("change", toggleCheckFields);
        toggleCheckFields();  // Ø§Ø¬Ø±Ø§ Ø§ÙˆÙ„ÛŒÙ‡
    });
</script>

<script>
    function formatInputNumber(input) {
        // Ø­Ø°Ù Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ØºÛŒØ±Ø¹Ø¯Ø¯ÛŒ
        let raw = input.value.replace(/,/g, '').replace(/[^\d]/g, '');
        input.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function clearIfZero(input) {
        if (input.value.trim() === "0" || input.value.trim() === "Û°") {
            input.value = "";
        }
    }
</script>
    
<script>
    $(document).ready(function() {
        $('#customerSelect').select2({
            placeholder: 'Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...',
            allowClear: true,
            language: "fa",
            ajax: {
                url: "{% url 'ajax_customer_search' %}",
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return { term: params.term };
                },
                processResults: function(data) {
                    return { results: data.results };
                },
                cache: true
            }
        });
    });
    </script>
    
    
{% endblock extra_js %}